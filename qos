#!/usr/bin/env sh

on=false

while true; do
    start=true

    /opt/bin/nmap -sP 192.168.0.100-103 | grep -qo '0 hosts up' || start=false

    if [ "$start" = true ] && [ "$(/opt/bin/wget -q --user admin --password admin 192.168.0.50/DI_S_.xml -O - | grep -co '0 Active Calls')" -eq 3 ]; then
        if [ "$on" = false ]; then
            /opt/bin/transmission-daemon
            on=true
        fi

        sleep 30
    else
        if [ "$on" = true ]; then
            /sbin/start-stop-daemon --stop --quiet --retry=TERM/10/KILL/5 --exec /opt/bin/transmission-daemon
            on=false
        fi

        sleep 600
    fi
done
